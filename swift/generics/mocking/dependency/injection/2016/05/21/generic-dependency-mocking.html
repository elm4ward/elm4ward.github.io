<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>The world is a generic type</title>
  <meta name="description" content="Mocking Dependencies with Generics">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://elm4ward.github.io/swift/generics/mocking/dependency/injection/2016/05/21/generic-dependency-mocking.html">
  <link rel="alternate" type="application/rss+xml" title="Mauersegler.swift" href="http://elm4ward.github.io/feed.xml">
  
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@elmkretzer" />
  <meta name="twitter:creator" content="@elmkretzer" />
  <meta name="twitter:title" content="New Swift Post: The world is a generic type" />
  <meta name="twitter:description" content="You can inject transparent dependencies by using generics and typealias Read the article on http://elm4ward.github.io" />
  <meta name="twitter:image" content="http://elm4ward.github.io/assets/dependencyinjection.jpg" />
  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Mauersegler.swift</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
          <a class="page-link" href="/imprint/">Imprint</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
       <p class="post-meta"><time datetime="2016-05-21T12:00:00+02:00" itemprop="datePublished">05/21/16</time>
       <small>‚úîÔ∏è Swift 2.2</small>
       <small>üéØ <a href="#gist">Straight to the Gist</a></small>
       </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h1 id="mocking-dependencies-with-generics">Mocking Dependencies with Generics</h1>

<blockquote>
  <p>TL;DR: You can inject code dependencies in a transparent way by using generics and typealias.</p>
</blockquote>

<p>Writing code in Swift is fun. Sometimes so much fun that we forget about an important detail.</p>

<p><strong>Writing Tests</strong>.  Yes. Sometimes we forget to write tests. We‚Äôve all been there. Honestly.</p>

<p><em>What to do?</em>
First of all - you open the existing empty test file and begin to implement a test.
But soon you will notice it‚Äôs not that easy to test your code independently.
Many parts are intertwined. You realize - you better get some kind of dependency injection.</p>

<h2 id="theres-more-than-one-way-to-skin-a-cat-">There‚Äôs more than one way to skin a cat üê±</h2>

<p>Here is a quote from <a href="https://en.wikipedia.org/wiki/Dependency_injection">wikipedia</a>:</p>

<blockquote>
  <p>In software engineering, dependency injection is a software design pattern that implements inversion of control for resolving dependencies. A dependency is an object that can be used (a service). An injection is the passing of a dependency to a dependent object (a client) that would use it. The service is made part of the client‚Äôs state.[1] Passing the service to the client, rather than allowing a client to build or find the service, is the fundamental requirement of the pattern.</p>
</blockquote>

<p>Basically what we want to do is - <em>while testing one part of the code base</em> - we want to fake (mock) the rest of the codebase.</p>

<p>Other ecosystems have some well-established techniques for this, like e.g. <a href="https://spring.io">Spring</a> on the JVM. Spring provides different flavors (like e.g. XML or Annotations) to glue your code together. Plus it provides an easy way to change that configuration for a test.</p>

<p>Turning to Swift:</p>

<p>Swift is not yet 2 years old. We are still searching for best practices. Every single application is different, thus the way I propose Dependency Injection may not work for every kind of application. Let‚Äôs start at the beginning.</p>

<p><em>You should google ‚ÄúDependency Injection Swift‚Äù now to read about some common patterns.</em></p>

<h2 id="first-there-was-an-item-">First there was an item üì¶</h2>

<p>We will build a really simple use case and add some more complexity later on. <em>Say hello to:</em></p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">/// the item</span>
<span class="kd">struct</span> <span class="kt">Item</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">date</span><span class="p">:</span> <span class="kt">NSDate</span>
<span class="p">}</span>
<span class="c1">/// a model that takes items </span>
<span class="kd">struct</span> <span class="kt">ModelFixed</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span>
  <span class="c1">// return only valid items with a date later than now</span>
  <span class="k">var</span> <span class="nv">validItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">now</span> <span class="o">=</span> <span class="kt">NSDate</span><span class="p">()</span> 
    <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="nf">laterDate</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span>  <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The two structs look pretty straight forward. In real life, however, this is really <strong>hard to test</strong>.</p>

<p><em>Why?</em> <br />
Because we use:  <code class="highlighter-rouge">let now = NSDate()</code>.<br />
Every time we call <code class="highlighter-rouge">NSDate()</code> it returns the <code class="highlighter-rouge">NSDate</code> of  now. <br />
Let‚Äôs imagine the following situation:</p>

<ul>
  <li>we have a list of items, which are valid when the item‚Äôs date is  <strong>after now</strong></li>
  <li>we want to ensure that only valid items are returned from the model</li>
  <li>furthermore we want to check the valid items  <strong>10 minutes later</strong></li>
  <li>and maybe it is important for us to check the same model a day later</li>
</ul>

<h2 id="freeze-the-world-">Freeze the world ‚ùÑÔ∏è</h2>

<p>Our first approach is to use a global <code class="highlighter-rouge">func</code> for getting <code class="highlighter-rouge">now</code>.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// a global var to change the 'now'</span>
<span class="k">var</span> <span class="nv">timeShift</span><span class="p">:</span> <span class="kt">NSDate</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">func</span> <span class="nf">getNow</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">NSDate</span> <span class="p">{</span>
  <span class="c1">// either we shift or we use `da real now`</span>
  <span class="k">return</span> <span class="n">timeShift</span> <span class="p">??</span> <span class="kt">NSDate</span><span class="p">()</span>
<span class="p">}</span>
 
<span class="kd">struct</span> <span class="kt">ModelGlobal</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span>
  <span class="k">var</span> <span class="nv">validItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span> <span class="p">{</span>
    <span class="c1">// we always get the NSDate we deserve</span>
    <span class="k">let</span> <span class="nv">now</span> <span class="o">=</span> <span class="nf">getNow</span><span class="p">()</span> 
    <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="nf">laterDate</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span>  <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// --------------------------------------------------------------------------</span>
<span class="c1">// MARK: - Test </span>
<span class="c1">// --------------------------------------------------------------------------</span>

<span class="k">let</span> <span class="nv">items</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">...</span><span class="mi">10</span><span class="p">)</span>
  <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="kt">Double</span><span class="p">(</span><span class="nv">$0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="p">}</span>
  <span class="o">.</span><span class="nf">map</span><span class="p">(</span><span class="kt">Item</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">date</span><span class="p">:))</span>
<span class="k">let</span> <span class="nv">globalModel</span> <span class="o">=</span> <span class="kt">ModelGlobal</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>

<span class="c1">// check valid: 'now'</span>
<span class="nf">assert</span><span class="p">(</span><span class="n">globalModel</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
<span class="c1">// jump to tomorrow</span>
<span class="n">timeShift</span> <span class="o">=</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
<span class="c1">//  check valid: 'tomorrow'</span>
<span class="nf">assert</span><span class="p">(</span><span class="n">globalModel</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></code></pre></figure>

<p><strong>Pro</strong>: super easy to implement</p>

<p><strong>Con</strong>: feels clunky + if we forget to reset the <code class="highlighter-rouge">timeShift</code> ‚Ä¶ üëπ</p>

<p>Come on, we will never ever forget to reset the <code class="highlighter-rouge">timeShift</code> because we wrap it like:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// closure executed at a different `now` than `NSDate()`</span>
<span class="kd">func</span> <span class="nf">withShiftedTime</span><span class="p">(</span><span class="nv">c</span><span class="p">:</span> <span class="p">()</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
  <span class="n">timeShift</span> <span class="o">=</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
  <span class="nf">c</span><span class="p">()</span>
  <span class="n">timeShift</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="p">}</span>
<span class="c1">// only inside the closure the time is different</span>
<span class="n">withShiftedTime</span> <span class="p">{</span>
  <span class="nf">assert</span><span class="p">(</span><span class="n">globalModel</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<h2 id="the-world-outside-">The world outside ‚òéÔ∏è</h2>

<p>Btw. time to add complexity: Did you know that valid items have to pass through a web API before they can be returned? Me neither.</p>

<p>Seems like we will have to implement a <code class="highlighter-rouge">WebService</code> and pass the valid items to the server for final verification. The <code class="highlighter-rouge">WebService</code>will be called in the model. But wait - when writing tests for the model we need to be able to mock the service.</p>

<p>Easy, therefore we <strong>initialize the model with<code class="highlighter-rouge">WebService</code></strong>. 
Have a look:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// --------------------------------------------------------------------------</span>
<span class="c1">// MARK: - 1st Dependency: WebService </span>
<span class="c1">//</span>
<span class="c1">// We start with a protocol and add a real and a mock webservice</span>
<span class="c1">// --------------------------------------------------------------------------</span>

<span class="kd">protocol</span> <span class="kt">WebServiceType</span> <span class="p">{</span>
  <span class="c1">/// should be promise-based ... you have to imagine </span>
  <span class="kd">func</span> <span class="nf">checkValid</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">],</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">(</span><span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">())</span>
<span class="p">}</span>
<span class="c1">/// real web wervice</span>
<span class="kd">struct</span> <span class="kt">WebService</span><span class="p">:</span> <span class="kt">WebServiceType</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">checkValid</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">],</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">(</span><span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
    <span class="c1">// do stuff - not interesting for the moment ... </span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">/// mocked web service </span>
<span class="kd">struct</span> <span class="kt">WebServiceMock</span><span class="p">:</span> <span class="kt">WebServiceType</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">checkValid</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">],</span> <span class="nv">completion</span><span class="p">:</span> <span class="p">(</span><span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
    <span class="nf">completion</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="c1">// fake a valid call</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// --------------------------------------------------------------------------</span>
<span class="c1">// MARK: - 2nd Dependency:  DateProvider</span>
<span class="c1">//</span>
<span class="c1">// we also use a protocol and provide a Now and a Tomorrow</span>
<span class="c1">// --------------------------------------------------------------------------</span>

<span class="kd">protocol</span> <span class="kt">DateProvider</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
<span class="c1">/// always the real current NSDate</span>
<span class="kd">struct</span> <span class="kt">Now</span><span class="p">:</span> <span class="kt">DateProvider</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NSDate</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">/// always the real current NSDate plus 1 day</span>
<span class="kd">struct</span> <span class="kt">Tomorrow</span><span class="p">:</span> <span class="kt">DateProvider</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// --------------------------------------------------------------------------</span>
<span class="c1">// MARK: - Model with injected dependencies</span>
<span class="c1">//</span>
<span class="c1">// in fact: there is way more code for configuring the dependencies</span>
<span class="c1">// than the business code itself</span>
<span class="c1">// --------------------------------------------------------------------------</span>

<span class="kd">struct</span> <span class="kt">ModelInjected</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span>
  <span class="k">let</span> <span class="nv">dateProvider</span><span class="p">:</span> <span class="kt">DateProvider</span>
  <span class="k">let</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceType</span>
  <span class="c1">/// provide all dependencies at init</span>
  <span class="nf">init</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">],</span> <span class="nv">dateProvider</span><span class="p">:</span> <span class="kt">DateProvider</span> <span class="o">=</span> <span class="kt">Now</span><span class="p">(),</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceType</span><span class="p">){</span>
    <span class="k">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>
    <span class="k">self</span><span class="o">.</span><span class="n">dateProvider</span> <span class="o">=</span> <span class="n">dateProvider</span>
    <span class="k">self</span><span class="o">.</span><span class="n">webService</span> <span class="o">=</span> <span class="n">webService</span>
  <span class="p">}</span>
 <span class="c1">//</span>
  <span class="k">var</span> <span class="nv">validItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span> <span class="p">{</span>
    <span class="c1">// how do you test that?</span>
    <span class="k">let</span> <span class="nv">now</span> <span class="o">=</span> <span class="n">dateProvider</span><span class="o">.</span><span class="n">now</span>
    <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="nf">laterDate</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span>  <span class="p">}</span>
  <span class="p">}</span>
 <span class="c1">// </span>
  <span class="kd">func</span> <span class="nf">sync</span><span class="p">(</span><span class="n">then</span> <span class="nv">callback</span><span class="p">:</span> <span class="p">([</span><span class="kt">Item</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
    <span class="n">webService</span><span class="o">.</span><span class="nf">checkValid</span><span class="p">(</span><span class="n">validItems</span><span class="p">){</span> <span class="n">ok</span> <span class="k">in</span>
      <span class="nf">callback</span><span class="p">(</span><span class="n">ok</span> <span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="nv">validItems</span> <span class="p">:</span> <span class="p">[])</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// --------------------------------------------------------------------------</span>
<span class="c1">// MARK: - Test</span>
<span class="c1">// --------------------------------------------------------------------------</span>

<span class="c1">///inject now + mock web service</span>
<span class="k">let</span> <span class="nv">modelInjected</span> <span class="o">=</span> <span class="kt">ModelInjected</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span> <span class="nv">dateProvider</span><span class="p">:</span> <span class="kt">Now</span><span class="p">(),</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceMock</span><span class="p">())</span>

<span class="nf">assert</span><span class="p">(</span><span class="n">modelInjected</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">modelInjected</span><span class="o">.</span><span class="n">sync</span> <span class="p">{</span> <span class="nf">assert</span><span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">/// inject tomorrow + mock web service</span>
<span class="k">let</span> <span class="nv">modelInjectedTomorrow</span> <span class="o">=</span> <span class="kt">ModelInjected</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span> <span class="nv">dateProvider</span><span class="p">:</span> <span class="kt">Tomorrow</span><span class="p">(),</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceMock</span><span class="p">())</span>

<span class="nf">assert</span><span class="p">(</span><span class="n">modelInjectedTomorrow</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">modelInjectedTomorrow</span><span class="o">.</span><span class="n">sync</span> <span class="p">{</span> <span class="nf">assert</span><span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">}</span></code></pre></figure>

<p>Kinda works.</p>

<p><strong>Pro</strong>: super flexible and decoupled</p>

<p><strong>Con</strong>: feels clunky</p>

<p>And to be honest: There is too much code in the model only related to dependency handling. <strong>Too much noise</strong>. The more dependencies you get, the more code you write for managing them inside your model. The <code class="highlighter-rouge">ModelGlobal</code>had 8 lines of code.
(w/o web service - fair enough), while <code class="highlighter-rouge">ModelInjected</code>nearly tripled that.
I am not sure if I want to do that.</p>

<p>Plus think about:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="kt">ModelInjected</span><span class="p">(</span>
  <span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span> 
  <span class="nv">dateProvider</span><span class="p">:</span> <span class="kt">Now</span><span class="p">(),</span> 
  <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebService</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">let</span> <span class="nv">_</span> <span class="o">=</span> <span class="kt">ModelInjected</span><span class="p">(</span>
  <span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span> 
  <span class="nv">dateProvider</span><span class="p">:</span> <span class="kt">Tomorrow</span><span class="p">(),</span> 
  <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceMock</span><span class="p">()</span>
<span class="p">)</span></code></pre></figure>

<p>Those dependencies are loosely coupled, but in my opinion they belong together in a semantic way.<br /> I even go one step further and claim:</p>

<blockquote>
  <p>The dependencies are the world your model lives in.</p>
</blockquote>

<p>There is a <em>Real World</em>, a <em>Mocked World</em> and maybe many many more.</p>

<h2 id="parallel-worlds-">Parallel Worlds üåì</h2>

<p>When our model is able to exist in parallel worlds, it might be a good idea to define it as generic type. But what kind of  boundary shall we use for the generic type?</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">/// the outer world</span>
<span class="c1">/// knows about the `now`, the services and there is even logging on top!</span>
<span class="kd">protocol</span> <span class="kt">Environment</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="k">var</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceType</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
  <span class="kd">static</span> <span class="k">var</span> <span class="nv">loggingService</span><span class="p">:</span> <span class="kt">LoggingServiceType</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Next up - we create the Real World:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// ----------------------------------------------------------------------------------------------</span>
<span class="c1">// MARK: - RealWorldEnvironment‚Ñ¢</span>
<span class="c1">//</span>
<span class="c1">// very fine granular configs possible, we start with:</span>
<span class="c1">// - RealWorldEnvironment protocol</span>
<span class="c1">// - RealWorldEnvironment protocol extension</span>
<span class="c1">// - RealWorld struct as a nominal type for the generic</span>
<span class="c1">// ----------------------------------------------------------------------------------------------</span>

<span class="kd">protocol</span> <span class="kt">RealWorldEnvironment</span><span class="p">:</span> <span class="kt">Environment</span> <span class="p">{}</span>

<span class="kd">extension</span> <span class="kt">RealWorldEnvironment</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NSDate</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="kd">static</span> <span class="k">var</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">WebService</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">RealWorld</span><span class="p">:</span> <span class="kt">RealWorldEnvironment</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="k">var</span> <span class="nv">loggingService</span><span class="p">:</span> <span class="kt">LoggingServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">LoggingService</span><span class="o">&lt;</span><span class="kt">RealWorld</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Only one step is missing to see the end result:</p>

<p>An environment-aware model that:</p>

<ul>
  <li>returns <code class="highlighter-rouge">validItems</code> with date after <code class="highlighter-rouge">now</code>of environment</li>
  <li>has a sync func that provides <code class="highlighter-rouge">validItems</code> to the web service of the environment, logs the server result (logging service of environment) and calls the callback with the corresponding items</li>
</ul>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// ----------------------------------------------------------------------------------------------</span>
<span class="c1">// MARK: - ModelFor </span>
<span class="c1">//</span>
<span class="c1">// An Environment aware Type</span>
<span class="c1">// ----------------------------------------------------------------------------------------------</span>

<span class="kd">typealias</span> <span class="kt">Model</span> <span class="o">=</span> <span class="kt">ModelFor</span><span class="o">&lt;</span><span class="kt">RealWorld</span><span class="o">&gt;</span>

<span class="kd">struct</span> <span class="kt">ModelFor</span><span class="o">&lt;</span><span class="kt">Env</span><span class="p">:</span> <span class="kt">Environment</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span>

  <span class="k">var</span> <span class="nv">validItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">Item</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">now</span> <span class="o">=</span> <span class="kt">Env</span><span class="o">.</span><span class="n">now</span>
    <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="n">filter</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="nf">laterDate</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">==</span> <span class="nv">$0</span><span class="o">.</span><span class="n">date</span>  <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">sync</span><span class="p">(</span><span class="n">then</span> <span class="nv">callback</span><span class="p">:</span> <span class="p">([</span><span class="kt">Item</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">())</span> <span class="p">{</span>
    <span class="kt">Env</span><span class="o">.</span><span class="n">webService</span><span class="o">.</span><span class="nf">checkValid</span><span class="p">(</span><span class="n">validItems</span><span class="p">){</span> <span class="n">ok</span> <span class="k">in</span>
      <span class="kt">Env</span><span class="o">.</span><span class="n">loggingService</span><span class="o">.</span><span class="nf">log</span><span class="p">(</span><span class="s">"Returned </span><span class="se">\(</span><span class="n">ok</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
      <span class="nf">callback</span><span class="p">(</span><span class="n">ok</span> <span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="nv">validItems</span> <span class="p">:</span> <span class="p">[])</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We end up with:</p>

<ul>
  <li>a generic <code class="highlighter-rouge">ModelFor</code> taking a type conforming to <code class="highlighter-rouge">Environment</code></li>
  <li>a typealias <code class="highlighter-rouge">Model</code>representing <code class="highlighter-rouge">ModelFor&lt;RealWorld&gt;</code></li>
  <li><strong>no</strong> code necessary to manage the dependencies with properties or whatever</li>
</ul>

<p><strong>All you write is:</strong> <code class="highlighter-rouge">let modelNow = Model(items: items)</code></p>

<p>What about mocking?</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// ----------------------------------------------------------------------------------------------</span>
<span class="c1">// MARK: - MockedWorldEnvironment</span>
<span class="c1">//</span>
<span class="c1">// the possible parallel worlds</span>
<span class="c1">// ----------------------------------------------------------------------------------------------</span>

<span class="c1">/// sunny -&gt; Online</span>
<span class="kd">protocol</span> <span class="kt">MockedOnlineWorldEnvironment</span><span class="p">:</span> <span class="kt">Environment</span> <span class="p">{}</span>

<span class="c1">/// stormy -&gt; Offline</span>
<span class="kd">protocol</span> <span class="kt">MockedOfflineWorldEnvironment</span><span class="p">:</span> <span class="kt">Environment</span> <span class="p">{}</span>

<span class="c1">/// the online base world</span>
<span class="kd">extension</span> <span class="kt">MockedOnlineWorldEnvironment</span> <span class="p">{</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">WebServiceMock</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// the offline base world</span>
<span class="kd">extension</span> <span class="kt">MockedOfflineWorldEnvironment</span> <span class="p">{</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">webService</span><span class="p">:</span> <span class="kt">WebServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">WebServiceOfflineMock</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ----------------------------------------------------------------------------------------------</span>
<span class="c1">// MARK: - Parallel Worlds</span>
<span class="c1">// ----------------------------------------------------------------------------------------------</span>

<span class="kd">struct</span> <span class="kt">WorldInTenSeconds</span><span class="p">:</span> <span class="kt">MockedOnlineWorldEnvironment</span> <span class="p">{</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">loggingService</span><span class="p">:</span> <span class="kt">LoggingServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">LoggingService</span><span class="o">&lt;</span><span class="kt">WorldInTenSeconds</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">WorldTomorrow</span><span class="p">:</span> <span class="kt">MockedOnlineWorldEnvironment</span> <span class="p">{</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">loggingService</span><span class="p">:</span> <span class="kt">LoggingServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">LoggingService</span><span class="o">&lt;</span><span class="kt">WorldTomorrow</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">WorldYesterdayOffline</span><span class="p">:</span> <span class="kt">MockedOfflineWorldEnvironment</span> <span class="p">{</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">now</span><span class="p">:</span> <span class="kt">NSDate</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NSDate</span><span class="p">()</span><span class="o">.</span><span class="nf">dateByAddingTimeInterval</span><span class="p">(</span><span class="o">-</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">static</span> <span class="k">var</span> <span class="nv">loggingService</span><span class="p">:</span> <span class="kt">LoggingServiceType</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">LoggingService</span><span class="o">&lt;</span><span class="kt">WorldYesterdayOffline</span><span class="o">&gt;</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We define a couple of different worlds and name them:</p>

<ul>
  <li>WorldInTenSeconds</li>
  <li>WorldTomorrow</li>
  <li>WorldYesterdayOffline</li>
</ul>

<p>The clear naming immediately gives an idea what kind of dependencies are used. And suddenly writing tests and changing conditions is a no-brainer.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// lets define 2 more typealiases in the test</span>
<span class="kd">typealias</span> <span class="kt">ModeInTenSeconds</span> <span class="o">=</span> <span class="kt">ModelFor</span><span class="o">&lt;</span><span class="kt">WorldInTenSeconds</span><span class="o">&gt;</span>
<span class="kd">typealias</span> <span class="kt">ModelYesterdayOffline</span> <span class="o">=</span> <span class="kt">ModelFor</span><span class="o">&lt;</span><span class="kt">WorldYesterdayOffline</span><span class="o">&gt;</span>

<span class="c1">/// a function to check an environment-aware model</span>
<span class="c1">/// - validCount</span>
<span class="c1">/// - and after sync</span>
<span class="kd">func</span> <span class="n">check</span><span class="o">&lt;</span><span class="kt">E</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">model</span><span class="p">:</span> <span class="kt">ModelFor</span><span class="o">&lt;</span><span class="kt">E</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">hasValidItems</span> <span class="nv">validCount</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">afterSync</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span><span class="p">){</span>
  <span class="c1">//</span>
  <span class="nf">print</span><span class="p">(</span><span class="s">"-&gt;"</span><span class="p">,</span> <span class="kt">E</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="s">"has"</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
  <span class="c1">// make sure the count is correct</span>
  <span class="nf">assert</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">validItems</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">validCount</span><span class="p">)</span>
  <span class="c1">// then check if after sync the count is correct as well</span>
  <span class="n">model</span><span class="o">.</span><span class="nf">sync</span><span class="p">(</span><span class="nv">then</span><span class="p">:</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">afterSyncCount</span> <span class="o">=</span> <span class="n">afterSync</span> <span class="p">??</span> <span class="n">validCount</span>
    <span class="c1">//</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"after accessing server"</span><span class="p">,</span> <span class="n">afterSyncCount</span><span class="p">)</span>
    <span class="nf">assert</span><span class="p">(</span><span class="nv">$0</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">afterSyncCount</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="c1">///  now</span>
<span class="k">let</span> <span class="nv">modelNow</span> <span class="o">=</span> <span class="kt">Model</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>
<span class="nf">check</span><span class="p">(</span><span class="n">modelNow</span><span class="p">,</span> <span class="nv">hasValidItems</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1">///  in ten seconds</span>
<span class="k">let</span> <span class="nv">modeInTenSeconds</span> <span class="o">=</span> <span class="kt">ModeInTenSeconds</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>
<span class="nf">check</span><span class="p">(</span><span class="n">modeInTenSeconds</span><span class="p">,</span> <span class="nv">hasValidItems</span><span class="p">:</span> <span class="mi">9</span><span class="p">)</span>

 <span class="c1">/// yesterday</span>
<span class="k">let</span> <span class="nv">modelYesterday</span> <span class="o">=</span> <span class="kt">ModelYesterday</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>
<span class="nf">check</span><span class="p">(</span><span class="n">modelYesterday</span><span class="p">,</span> <span class="nv">hasValidItems</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1">/// tomorrow (no typealias ... )</span>
<span class="k">let</span> <span class="nv">modelTomorrow</span> <span class="o">=</span>  <span class="kt">ModelFor</span><span class="o">&lt;</span><span class="kt">WorldTomorrow</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>
<span class="nf">check</span><span class="p">(</span><span class="n">modelTomorrow</span><span class="p">,</span> <span class="nv">hasValidItems</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">/// tomorrow but offline</span>
<span class="k">let</span> <span class="nv">modelYesterdayOffline</span> <span class="o">=</span> <span class="kt">ModelYesterdayOffline</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>
<span class="nf">check</span><span class="p">(</span><span class="n">modelYesterdayOffline</span><span class="p">,</span> <span class="nv">hasValidItems</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nv">afterSync</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span></code></pre></figure>

<p>What does the output look like:</p>
<pre>
-&gt; RealWorld has 10
-&gt; WorldInTenSeconds has 9
2016-05-21 11:30:10 +0000 Returned true
after accessing server 9
-&gt; WorldYesterday has 10
2016-05-20 11:30:00 +0000 Returned true
after accessing server 10
-&gt; WorldTomorrow has 0
2016-05-22 11:30:00 +0000 Returned true
after accessing server 0
-&gt; WorldYesterdayOffline has 10
2016-05-20 11:30:00 +0000 Returned false
after accessing server 0
</pre>

<p>Even the time output of the logging service is changing according to the <code class="highlighter-rouge">Environment</code>.</p>

<ul>
  <li><strong>no</strong> need to manage global state</li>
  <li><strong>no</strong> need to explicitly inject dependencies</li>
  <li><strong>no</strong> need to use the generic type in the code: just use the typealias</li>
</ul>

<p><strong>Bonus Feature</strong></p>

<p>Refactoring looks like:</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">struct</span> <span class="kt">MyComplexThing</span> <span class="p">{}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="kd">typealias</span> <span class="kt">MyComplexThing</span> <span class="o">=</span> <span class="kt">ComplexThingFor</span><span class="o">&lt;</span><span class="kt">RealWorld</span><span class="o">&gt;</span>
<span class="kd">struct</span> <span class="kt">ComplexThingFor</span><span class="o">&lt;</span><span class="kt">Env</span><span class="p">:</span> <span class="kt">Environment</span><span class="o">&gt;</span> <span class="p">{}</span></code></pre></figure>

<p>In my opinion the generic approach is a lean Swift solution for a well known problem. Of course you can argue that it is a little bit verbose when you already use a generic model. But looking ahead: Swift 3 will give us generic typealias - so no need to worry.</p>

<figure class="highlight"><pre><code class="language-swift" data-lang="swift"><span class="c1">// Swift 3</span>
<span class="kd">struct</span> <span class="kt">MyGenericModelFor</span><span class="o">&lt;</span><span class="kt">E</span><span class="p">:</span> <span class="kt">Environment</span><span class="p">,</span> <span class="kt">T</span><span class="o">&gt;</span> <span class="p">{}</span>
<span class="kd">typealias</span> <span class="kt">MyGenericModel</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span> <span class="o">=</span> <span class="kt">MyGenericModelFor</span><span class="o">&lt;</span><span class="kt">RealWorld</span><span class="p">,</span> <span class="kt">T</span><span class="o">&gt;</span></code></pre></figure>

<p>Interested in playing around? Here we go with a full playground:</p>

<h2 id="the-gist-of-it-">The gist of it üëª</h2>

<p><span id="gist"></span></p>
<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/4d477f57550c571f00f203ed89c5d8c4.js"> </script>

<p>üëª Feel free to hit me on twitter.
<a href="https://twitter.com/elmkretzer">@elmkretzer</a></p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-4">
        <p>Mauersegler.swift - In the long term, this will be a blog about using Swift. 
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
